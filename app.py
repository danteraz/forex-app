import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
import os
from pathlib import Path
from utils.forex_api import obter_preco_atual, obter_historico

ARQUIVO_HISTORICO = Path("data/historico.csv")
ARQUIVO_HISTORICO.parent.mkdir(parents=True, exist_ok=True)

st.set_page_config(page_title="üìà Forex App", layout="wide")
st.title("üìä Painel de Forex - App Pessoal")

# Par de moedas dispon√≠veis
pares = [
    "EUR/USD", "GBP/USD", "USD/JPY", "USD/CHF", "AUD/USD",
    "NZD/USD", "USD/CAD", "EUR/GBP", "EUR/JPY", "GBP/JPY"
]
par = st.selectbox("Escolha o par de moedas", pares)

# Exibir pre√ßo atual
preco = obter_preco_atual(par)
if preco:
    st.metric(label=f"üí∞ Pre√ßo atual de {par}", value=f"${preco}")
else:
    st.error("Erro ao obter o pre√ßo do par.")

# Hist√≥rico + M√©dia M√≥vel
df = obter_historico(par)

if df is None or df.empty:
    st.warning("‚ö†Ô∏è Dados hist√≥ricos n√£o dispon√≠veis para este par de moedas.")
else:
    # C√°lculo de m√©dias e gr√°fico
    df["SMA9"] = df["close"].rolling(window=9).mean()
    df["SMA21"] = df["close"].rolling(window=21).mean()

    st.subheader("üìà Gr√°fico de Pre√ßos e M√©dias M√≥veis")
    fig, ax = plt.subplots(figsize=(10, 4))
    ax.plot(df["datetime"], df["close"], label="Pre√ßo", color="black")
    ax.plot(df["datetime"], df["SMA9"], label="M√©dia M√≥vel 9", linestyle="--")
    ax.plot(df["datetime"], df["SMA21"], label="M√©dia M√≥vel 21", linestyle=":")
    ax.legend()
    ax.grid(True)
    st.pyplot(fig)

    # Alerta de sinal
    if df["SMA9"].iloc[-2] < df["SMA21"].iloc[-2] and df["SMA9"].iloc[-1] > df["SMA21"].iloc[-1]:
        st.success("üîî SINAL DE **COMPRA** detectado (SMA9 cruzou para cima a SMA21)")
    elif df["SMA9"].iloc[-2] > df["SMA21"].iloc[-2] and df["SMA9"].iloc[-1] < df["SMA21"].iloc[-1]:
        st.error("üîî SINAL DE **VENDA** detectado (SMA9 cruzou para baixo a SMA21)")
    else:
        st.info("‚è≥ Nenhum sinal claro no momento.")

    # ====================
    # Simula√ß√£o de opera√ß√µes
    # ====================
    st.subheader("üõí Opera√ß√µes Simuladas")

    # Inicializa o hist√≥rico (sess√£o + CSV)
    if "historico" not in st.session_state:
        if ARQUIVO_HISTORICO.exists():
            st.session_state.historico = pd.read_csv(ARQUIVO_HISTORICO, parse_dates=["Data"]).to_dict("records")
        else:
            st.session_state.historico = []

    # Bot√µes de simula√ß√£o
    col1, col2 = st.columns(2)

    def registrar_operacao(tipo):
        nova_op = {
            "Data": pd.Timestamp.now(),
            "Par": par,
            "Pre√ßo": preco,
            "Opera√ß√£o": tipo
        }
        st.session_state.historico.append(nova_op)
        df_atual = pd.DataFrame(st.session_state.historico)
        df_atual.to_csv(ARQUIVO_HISTORICO, index=False)

    with col1:
        if st.button("‚úÖ Comprar"):
            registrar_operacao("COMPRA")

    with col2:
        if st.button("‚ùå Vender"):
            registrar_operacao("VENDA")

    df_ops = pd.DataFrame(st.session_state.historico)

    if not df_ops.empty:
        st.dataframe(df_ops.sort_values("Data", ascending=False), use_container_width=True)

        # C√°lculo de lucro/preju√≠zo
        lucro_total = 0
        operacoes = []
        entrada = None

        for _, row in df_ops.iterrows():
            if row["Opera√ß√£o"] == "COMPRA" and entrada is None:
                entrada = row  # Marca o ponto de entrada
            elif row["Opera√ß√£o"] == "VENDA" and entrada is not None:
                # Calcula lucro/preju√≠zo
                lucro = row["Pre√ßo"] - entrada["Pre√ßo"]
                resultado = f"{entrada['Par']}: COMPRA {entrada['Pre√ßo']:.2f} ‚Üí VENDA {row['Pre√ßo']:.2f} = Lucro {lucro:.2f}"
                operacoes.append(resultado)
                lucro_total += lucro
                entrada = None  # Reseta para aguardar nova compra

        st.subheader("üìä Resultados das Opera√ß√µes Simuladas")

        if operacoes:
            for op in operacoes:
                st.write("‚Ä¢", op)
            st.success(f"üí∞ Lucro/Preju√≠zo acumulado: **${lucro_total:.2f}**")
        else:
            st.info("Nenhum ciclo completo de COMPRA ‚Üí VENDA foi registrado ainda.")
    else:
        st.info("Nenhuma opera√ß√£o simulada registrada ainda.")
